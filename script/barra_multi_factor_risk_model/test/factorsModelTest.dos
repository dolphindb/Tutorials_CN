use barra::barraFactorsCal
use barra::barraFactorsMerge
use barra::barraFactorsModel
/* Barraå¤šå› å­æ¨¡å‹å…¨æµç¨‹*/

/* 1.æ”¶ç›Šé£é™©æ¨¡å‹
 */
 
// ä¸€çº§å› å­æ”¶ç›Šç‡å›å½’  ï¼ˆå¯ä»¥è·å¾—å¤šå› å­æ¨¡å‹çš„R2ã€t-statã€æœˆé¢‘çš„å› å­æ”¶ç›Šã€ç‰¹è´¨æ”¶ç›Šã€é£é™©å› å­åæ–¹å·®çŸ©é˜µã€ç‰¹è´¨é£é™©è¡¨ã€biasç»Ÿè®¡é‡ï¼Œå› ä¸ºç»“æœè¾ƒå¤šï¼Œå¦‚éœ€æŸ¥çœ‹ï¼Œæ¨èæŒä¹…åŒ–åå†æŸ¥çœ‹ç»“æœï¼Œæˆ–è€…å¯ä»¥å–å‡ºæ¥éƒ¨åˆ†è¾ƒå°‘çš„ç»“æœï¼‰
retOut1 = getRetTable(facTable1,adjust = true)                                    // adjusté‡‡ç”¨Newey-Weståæ–¹å·®è°ƒæ•´ã€å½“å¸‚åœºæ”¶ç›Šç‡å­˜åœ¨åºåˆ—è‡ªç›¸å…³æ—¶é‡‡ç”¨æ­¤æ–¹æ³•
retOut1 = getRetTable(facTable1,adjust = false,shrink = false)                    // shrinké‡‡ç”¨è´å¶æ–¯æ”¶ç¼©è°ƒæ•´ç‰¹å¼‚æ€§é£é™©ã€æ¨èä½¿ç”¨
retOut1 = getRetTable(facTable1,adjust = true,shrink = true)                      // ç‰¹å¼‚æ€§é£é™©é‡‡ç”¨bayesian shrinkage
retOut1 = getRetTable(facTable1,adjust = true,shrink = true,eigenfactor = true)   // å› å­é£é™©é‡‡ç”¨eigenfactor adjust,å½“å¸‚åœºå…³è”å¯†åˆ‡æ—¶é‡‡ç”¨æ­¤æ–¹æ³•
retOut1 = getRetTable(facTable1,adjust = true,shrink = true,eigenfactor = true)   // ç»¼ä¸Šï¼Œæ¨èä½¿ç”¨
retOut1 = getRetTable(facTable1,adjust = false,shrink = true,eigenfactor = true)  // ç»¼ä¸Šï¼Œæ¨èä½¿ç”¨
retOut1 = getRetTable(facTable1,adjust = false,shrink = true,eigenfactor = true)  // ç»¼ä¸Šï¼Œæ¨èä½¿ç”¨
retOut1 = getRetTable(fTable,adjust = false,shrink = true,eigenfactor = false)    // ç»¼ä¸Šï¼Œæ¨èä½¿ç”¨
undef(`retOut)
retOut = getRetTable(facTable1,adjust = true,shrink = false ,eigenfactor = false)  // ç»¼ä¸Šï¼Œæ¨èä½¿ç”¨

// ä¾‹å¦‚
retOut1.stock_risk[string(2022.12.30)]   // 12.30çš„ç‰¹è´¨æ”¶ç›Šåæ–¹å·®çŸ©é˜µ
retOut1.fac_risk[string(2022.12.30)]     // 12.30çš„é£é™©å› å­åæ–¹å·®çŸ©é˜µ
retOut1.R2                               // R2
retOut1.res                              // ç‰¹è´¨æ”¶ç›Š
retOut1.tstat                            // t-stat
retOut1.fac_ret                          // å› å­æ”¶ç›Š
retOut1.bias                             // biasç»Ÿè®¡é‡

select `All_Factors_R2,mean(stR2) from retOut.R2  where record_date between 2022.01.01 and 2023.01.01

plot(retOut1.R2.stR2,retOut1.R2.record_date,"ğ‘†ğ‘¡ğ‘¢ğ‘‘ğ‘’ğ‘›ğ‘¡ğ‘–ğ‘§ğ‘’ğ‘‘ R2 æœˆé¢‘æ—¶åºå›¾")

retOut2 = getRetTable(facTable2)     // äºŒçº§å› å­æ”¶ç›Šç‡å›å½’,ç›¸åº”å¯ä»¥å¾—åˆ°å¯¹åº”æ¨¡å‹æ£€éªŒç»“æœ
retOut3 = getRetTable(fTable)        // ä¸‰çº§å› å­æ”¶ç›Šç‡å›å½’,ç›¸åº”å¯ä»¥å¾—åˆ°å¯¹åº”æ¨¡å‹æ£€éªŒç»“æœ
predictOut = getPredicOut(facTable1)         // ç»“æœè¾ƒå¤šï¼Œå¦‚éœ€æŸ¥çœ‹ï¼Œæ¨èæŒä¹…åŒ–åå†æŸ¥çœ‹ç»“æœï¼Œæˆ–è€…å¯ä»¥å–å‡ºæ¥éƒ¨åˆ†è¾ƒå°‘çš„ç»“æœï¼Œé™¤å»é¢„æµ‹æ”¶ç›Šå¤–ï¼ŒåŒ…å«R2ã€t-statã€æœˆé¢‘çš„å› å­æ”¶ç›Šã€ç‰¹è´¨æ”¶ç›Šã€é£é™©å› å­åæ–¹å·®çŸ©é˜µã€ç‰¹è´¨é£é™©è¡¨ã€biasç»Ÿè®¡é‡çš„æ‰€æœ‰ç»“æœ
pr = select * from predictOut.predict_ret    // åˆ©ç”¨æœ¬æœŸå› å­æš´éœ²é¢„æµ‹æœ€åä¸€æœŸçš„æ”¶ç›Šç‡

predictOut.R2                               // é¢„æµ‹æ¨¡å‹R2
predictOut.res                              // é¢„æµ‹æ¨¡å‹ç‰¹è´¨æ”¶ç›Š
predictOut.tstat                            // é¢„æµ‹æ¨¡å‹t-stat
predictOut.fac_ret                          // é¢„æµ‹æ¨¡å‹å› å­æ”¶ç›Š
predictOut.bias                             // é¢„æµ‹æ¨¡å‹biasç»Ÿè®¡é‡


/* 2.é¢„æµ‹ä¸ªè‚¡æ”¶ç›Š
 */ 
predictOut = getPredicOut(facTable1)         // ç»“æœè¾ƒå¤šï¼Œå¦‚éœ€æŸ¥çœ‹ï¼Œæ¨èæŒä¹…åŒ–åå†æŸ¥çœ‹ç»“æœï¼Œæˆ–è€…å¯ä»¥å–å‡ºæ¥éƒ¨åˆ†è¾ƒå°‘çš„ç»“æœï¼Œé™¤å»é¢„æµ‹æ”¶ç›Šå¤–ï¼ŒåŒ…å«R2ã€t-statã€æœˆé¢‘çš„å› å­æ”¶ç›Šã€ç‰¹è´¨æ”¶ç›Šã€é£é™©å› å­åæ–¹å·®çŸ©é˜µã€ç‰¹è´¨é£é™©è¡¨ã€biasç»Ÿè®¡é‡çš„æ‰€æœ‰ç»“æœ
pr = select * from predictOut.predict_ret    // åˆ©ç”¨æœ¬æœŸå› å­æš´éœ²é¢„æµ‹æœ€åä¸€æœŸçš„æ”¶ç›Šç‡
predictOut.R2                               // é¢„æµ‹æ¨¡å‹R2
predictOut.res                              // é¢„æµ‹æ¨¡å‹ç‰¹è´¨æ”¶ç›Š
predictOut.tstat                            // é¢„æµ‹æ¨¡å‹t-stat
predictOut.fac_ret                          // é¢„æµ‹æ¨¡å‹å› å­æ”¶ç›Š
predictOut.bias                             // é¢„æµ‹æ¨¡å‹biasç»Ÿè®¡é‡


/* 3.ç»„åˆæƒé‡ä¼˜åŒ–
 */  
optionCode = exec stock_code from getPredicOut(facTable1).predict_ret order by return_day desc limit 20             // åˆæ­¥ç­›é€‰stock1
optionCode = exec stock_code from getPredicOut(facTable2).predict_ret order by return_day desc limit 20  

// æ§åˆ¶æ”¶ç›Šã€æœ€å°åŒ–é£é™©æ¨¡å‹
portWeight1 = getOptimizeWeights(facTable = facTable1,retOut = retOut1,st = st,et = et, method ="minRiskControlRet",r = 0.05,optionCode = optionCode)      // è·å¾—æƒé‡ç»„åˆ
portWeight2 = getOptimizeWeights(facTable = facTable2,retOut = retOut2,st = st,et = et, method ="minRiskControlRet",r = 0.05,optionCode = optionCode)

index_code = '000300'
CodePre = set(exec stock_code from getPredicOut(facTable1).predict_ret order by return_day desc limit 200)           // åˆæ­¥ç­›é€‰stock2
CodeWeight = set(exec stock_code from getBenchMark(st=st,et=et,code = index_code) where i_weight != 0)
CodeFac =set(exec stock_code from facTable1 )
optionCode = (CodePre&CodeWeight&CodeFac).keys()
portWeight3 = getOptimizeWeights(facTable = facTable1,retOut = retOut1,st = st,et = et, method ="minRiskControlRet",r = 0.005,deStyle = true,optionCode = optionCode)      // è·å¾—æƒé‡ç»„åˆ,å¹¶å®ç°åœ¨é£æ ¼ä¸Šçš„é£é™©æ•å£ä¸º0
portWeight3 = getOptimizeWeights(facTable = facTable1,retOut = retOut1,st = st,et = et, method ="minRiskControlRet",r = 0.005,deIndustry = true,optionCode = optionCode)   // è·å¾—æƒé‡ç»„åˆ,å¹¶å®ç°åœ¨è¡Œä¸šä¸Šçš„é£é™©æ•å£ä¸º0
portWeight4 = getOptimizeWeights(facTable = facTable2,retOut = retOut2,st = st,et = et, method ="minRiskControlRet",r = 0.05,optionCode = optionCode)




/* 4.èµ„äº§é…ç½®è¯„ä¼°
 */  

/* 4.1äº‹åèµ„äº§é…ç½®è¯„ä¼°
 */
 
/* 4.1.1 äº‹åå› å­ç»„åˆè¯„ä¼°
 */

// åˆæˆä¸€çº§ã€äºŒçº§å› å­ 
//  firstFactorsä¸­ä¸€çº§å› å­å’ŒäºŒçº§å› å­åç§°ä»»èµ·ï¼›firstFactorsä¸­äºŒçº§å› å­çš„åç§°éœ€è¦ä¸secondFactorsä¸­çš„äºŒçº§å› å­çš„åç§°ä¸€ä¸€å¯¹åº”ï¼›secondFactorsä¸­çš„ä¸‰çº§å› å­éœ€è¦ä¸è¾“å…¥çš„å› å­è¡¨factorsTable å­—æ®µåå¯¹åº”ï¼ˆæ”¯æŒå¤§å°å†™åŒ¹é…ï¼‰
//  ä¸€çº§å› å­å’ŒäºŒçº§å› å­çš„jsonï¼Œå¯æ ¹æ®æ£€éªŒç»“æœä¿®æ”¹å…³ç³»,è‹¥æœ‰éœ€æ±‚ï¼Œå¯è‡ªè¡Œæ·»åŠ å…¶ä»–å› å­
index_code = '000300'
st = 2022.01.03 
et = 2023.01.02
normlizing = true
scaling = true
decap = true
industry_method = 'CITIC'
industry_weighted = true
Factors = getAllFactors(st= st,et = et, normlizing = normlizing,scaling = scaling,decap = decap,industry_method = industry_method,industry_weighted = industry_weighted)
// 5min 18s

firstFactors = {
    "Quality":["Earnings_Quality","Earnings_Variability","Investment_Quality","Leverage","Profitability"],
    "Value":["Btop","Earning_Yield","Long_Term_Reversal"],
    "Growth":"Growth",
    "Liquidity":"Liquidity",
    "Volatility":["Beta","Residual_Volatility"],
    "Size":["Size","Mid_Cap"],
    "Momentum":"Momentum",
    "Dividend_Yield":"Dividend_Yield"
}   

// äºŒçº§å› å­å’Œä¸‰çº§å› å­çš„jsonï¼Œå¯æ ¹æ®æ£€éªŒç»“æœä¿®æ”¹å…³ç³»ï¼Œä¸‰çº§å› å­ä¸€èˆ¬éœ€è¦é€‰æ‹©ttmå’Œlyrç§ç±»çš„å› å­
// ä¸‰çº§å› å­å­—å…¸è¡¨
/* ['abs','acf_ttm','acf_lyr','vsal_ttm','vsal_lyr','vern_ttm','vern_lyr','vflo_ttm','vflo_lyr','cetop_ttm','cetop_lyr','etop_ttm','etop_lyr','egro_ttm','egro_lyr','sgro_ttm','sgro_lyr','agro','igro','mlev','dtoa','blev','stom','stoq','stoa','atvr','ltrstr','lthalpha','midcap','rstr','halpha','ato_ttm','ato_lyr','roa_ttm','roa_lyr','btop','dtop','hbeta','hsigma','dastd','cmra','lncap','cxgro','gp_ttm','gp_lyr','gpm_ttm','gpm_lyr','em'] */
secondFactors = {
"Earnings_Quality":["abs","acf_ttm"],
"Earnings_Variability":["vsal_ttm","vern_ttm","vflo_ttm"],
"Investment_Quality":["agro","igro","cxgro"],
"Leverage":["mlev","dtoa","blev"],
"Profitability":["ato_ttm","gp_ttm","gpm_ttm","roa_ttm"],
"Btop":"btop",
"Earning_Yield":["cetop_ttm","etop_ttm","em"],
"Long_Term_Reversal":["ltrstr","lthalpha"],
"Growth":["egro_ttm","sgro_ttm"],
"Liquidity":["stom","stoq","stoa","atvr"],
"Beta":"hbeta",
"Residual_Volatility":["hsigma","dastd","cmra"],
"Size":"lncap",
"Mid_Cap":"midcap",
"Momentum":["rstr","halpha"],
"Dividend_Yield":"dtop"
}

// 3.8s
fTable = getRegTable(factorsTable = true,tbName = Factors,st= st,et = et, normlizing = normlizing ,scaling = scaling ,decap = decap,industry_method = industry_method,industry_weighted = industry_weighted)

// 10s
factorsValid = getFactorsValidation(factorsTable = true,tbName = Factors,st = st,et = et , normlizing = normlizing,scaling = scaling,decap = decap,industry_method = industry_method,industry_weighted = industry_weighted)

// 179ms
facTable1 = getFSLevelFactor(fTable,factorsValid,firstFactors,secondFactors,false, "equal",level = "F")

// 1 min 35 s
retOut = getRetTable(facTable1,adjust = true,shrink = false ,eigenfactor = false)  

// 710ms
// è·å–æ‰€æœ‰å› å­çš„æ—¶åºbiasç»Ÿè®¡é‡çš„å€¼å’Œæ‰€æœ‰ä¸ªè‚¡çš„æ—¶åºbiasç»Ÿè®¡é‡å€¼
biasOut = getFacSpecialBias(retOut)

// å› å­bias
tmpfBias = select bias_stat from biasOut.fac_bias pivot by record_date,valueType
tmpfBias = tmpfBias[23:]
tbfBias = sql(select = sqlCol(tmpfBias.columnNames()[1:9]),from = tmpfBias).eval()
plot(tbfBias,tmpfBias.record_date,extras={multiYAxes: false},title = "å› å­æ¨¡å‹å› å­Biasç»Ÿè®¡é‡æ—¶åºå›¾")
plot(tbfBias,tmpfBias.record_date,extras={multiYAxes: false})
code0 = parseExpr("rowAvg("+ concat(tmpfBias.columnNames()[1:],',') + ")")
avgfBias =  sql(select = sqlColAlias(code0,'avg_bias_stat'),from = tmpfBias ).eval()
plot(avgfBias,tmpfBias.record_date,extras={multiYAxes: false},title = "å› å­å‡å€¼Biasç»Ÿè®¡é‡æ—¶åºå›¾")
plot(avgfBias,tmpfBias.record_date,extras={multiYAxes: false})

// ä¸ªè‚¡ç‰¹å¼‚bias
tmpsBias = select mean(bias_stat) from biasOut.stock_bias group by record_date
tmpsBias = tmpsBias[23:]
plot(tmpsBias.avg_bias_stat,tmpsBias.record_date,extras={multiYAxes: false},title = "å› å­æ¨¡å‹ç‰¹å¼‚é£é™©Biasç»Ÿè®¡é‡æ—¶åºå›¾")

/* 4.1.2 ç®€å•èµ„äº§é…ç½®è¯„ä¼°
 */
// è®¡ç®—æŒ‡æ•°é…ç½®çš„Biasç»Ÿè®¡é‡
tmpIndexbiasbn = getFacSpecialBias(retOut,'000300','equal').stock_bias
tmpIndexBias = select wavg(bias_stat,weight) from tmpIndexbiasbn group by record_date
plot(tmpIndexBias.wavg_bias_stat,tmpIndexBias.record_date,extras={multiYAxes: false})

tmpIndexbiasbn = getFacSpecialBias(retOut,'000300','float_market').stock_bias
tmpIndexBias = select wavg(bias_stat,weight) from tmpIndexbiasbn group by record_date
plot(tmpIndexBias.wavg_bias_stat,tmpIndexBias.record_date,extras={multiYAxes: false})

/* 4.2 äº‹å‰èµ„äº§é…ç½®è¯„ä¼°
è®¡ç®—é¢„æµ‹æ¨¡å‹çš„biasã€qç»Ÿè®¡é‡
éœ€è¦ç»™å‡ºæœˆé¢‘çš„èµ„äº§ç»„åˆä¼˜åŒ–æƒé‡æ¨¡å‹çš„ç»“æœ
ä¸‹é¢ä¾‹å­ä¸ºæ¨¡æ‹Ÿ
æ¨¡å‹ä¸å˜ï¼Œä¾‹å¦‚éƒ½æ˜¯æ§åˆ¶æ”¶ç›Šã€æœ€å°åŒ–é£é™©--->æ­¤å¤„æƒé‡éœ€è¦é€šè¿‡ç»„åˆæƒé‡ä¼˜åŒ–ï¼Œé€šè¿‡æœºå™¨å­¦ä¹ 
åˆ©ç”¨å‰n-1æœŸæ•°æ®é¢„æµ‹ç¬¬næœŸï¼Œç»™å‡ºç¬¬næœŸçš„ç»Ÿè®¡é‡ï¼Œå¦‚æœéœ€è¦è·å–æ¯ä¸€æœŸçš„ç»Ÿè®¡é‡ã€æ¯ä¸€æœŸå¯¹æ¨¡å‹ç»™å‡ºä¼°è®¡åï¼Œéƒ½åº”è¯¥æŠŠå‰tæœŸçš„tbNameã€facTableã€retOutç»“æœä»£å…¥åˆ°è¯¥å‡½æ•°ï¼ˆè®¾ä¸ºç¬¬tæœŸï¼‰ï¼Œå¾—åˆ°ç¬¬tæœŸçš„ç»Ÿè®¡é‡ç»“æœ */

bm = select stock_code,record_date,month(record_date) as month,i_weight from  getBenchMark(st=st,et=et,code = index_code)
bmBegin = select first(i_weight) as i_weight from bm group by stock_code,month 
getPortfolioTest(bmBegin,facTable1,retOut,st,et)

/* è®¡ç®—é¢„æµ‹æ¨¡å‹çš„biasã€qç»Ÿè®¡é‡ */
// çœŸå®æ•°æ®
index_code = '000300'
st = 2022.01.03 
et = 2023.01.02
outAccurary = getPortfolioAccuracy(st,et,facTable1,retOut,index_code,'equal')
outAccurary = outAccurary[2:]
baseline = take(1,(shape outAccurary)[0])
plot(table(outAccurary.bias_statistic,baseline),outAccurary.record_date,extras={multiYAxes: false})
mean(outAccurary) 